addressLength=10;dataUserAddress=null;geoModal=null;function initAdddress(){setTimeout(function initAdddress(){dataUserAddress=document.querySelectorAll("[data-address]");if(dataUserAddress){dataUserAddress.forEach(function(area){if(area.tagName==="SELECT"){area.addEventListener("change",event=>{document.querySelector("[data-latitude]").value=area.options[area.selectedIndex].dataset.lati;document.querySelector("[data-longitude]").value=area.options[area.selectedIndex].dataset.longi})}else{area.addEventListener("focus",geocodeAddress)}});return}setTimeout(initAdddress,100)},100)}initAdddress();function geocodeAddress(){const request=new XMLHttpRequest;let address=this.value;address=address.replace("/","-");let url="/geocode/"+address;request.open("GET",url);request.setRequestHeader("X-Requested-With","XMLHttpRequest");request.addEventListener("readystatechange",function(evemnt){if(request.readyState===4&&request.status===200){let modal=document.getElementById("modal_address");if(!modal){modal=document.getElementById("modal")}modal.innerHTML=request.responseText;geoModal=new bootstrap.Modal(modal,{keyboard:false});geoModal.show();modal.addEventListener("hidden.bs.modal",function(event){this.innerHTML=""});modal.addEventListener("shown.bs.modal",function(event){modal.querySelectorAll("[data-address]").forEach(function(area){if(typeof replaceGeocodeAddress.debounce==="function"){area.addEventListener("input",function(event){modal.querySelectorAll(".spinner-border").forEach(function(indicator){btn=indicator.closest("button");indicator.classList.remove("d-none");btn.disabled=true;btn.type="button"})});replaceGeocodeAddress();area.addEventListener("input",replaceGeocodeAddress.debounce(2e3))}});let repeat=100;setTimeout(function UMzLVLSAMe(){if(repeat>=1e3){return}if(typeof ymaps==="object"){ymaps.ready(init)}repeat=repeat*2;setTimeout(UMzLVLSAMe,repeat)},100);modal.querySelectorAll("form").forEach(function(forms){forms.addEventListener("submit",function(event){event.preventDefault();geoModal.hide();return false})})});if($html){$html=request.responseText}}else{}});request.send();return false}function replaceGeocodeAddress(){if(typeof this.value=="undefined"||this.value.length<addressLength){return}const request=new XMLHttpRequest;let address=this.value;address=address.replace("/","-");let url="/geocode/"+address;request.open("GET",url);request.setRequestHeader("X-Requested-With","XMLHttpRequest");request.addEventListener("readystatechange",function(evemnt){if(request.readyState===4&&request.status===200){let modal=document.getElementById("modal_address");if(!modal){modal=document.getElementById("modal")}modal.innerHTML=request.responseText;modal.querySelectorAll("[data-address]").forEach(function(area){if(typeof replaceGeocodeAddress.debounce==="function"){area.addEventListener("input",function(event){modal.querySelectorAll(".spinner-border").forEach(function(indicator){btn=indicator.closest("button");indicator.classList.remove("d-none");btn.disabled=true;btn.type="button"})});area.addEventListener("input",replaceGeocodeAddress.debounce(2e3))}ymaps.ready(init)});modal.querySelectorAll("form").forEach(function(forms){forms.addEventListener("submit",function(event){console.log();event.preventDefault();submitAddressForm(forms);return false})});if($html){$html=request.responseText}}else{}});request.send();return false}function init(){let geocode=document.getElementById("user_address_form_desc");let latitude=document.getElementById("user_address_form_latitude");let longitude=document.getElementById("user_address_form_longitude");myMap=new ymaps.Map("map",{center:[latitude.value,longitude.value],controls:["routeButtonControl","fullscreenControl"],zoom:geocode.value?17:6});if(geocode.value){myMap.geoObjects.add(new ymaps.Placemark([latitude.value,longitude.value],{balloonContent:geocode.value,iconCaption:geocode.value},{preset:"islands",iconColor:"#4684D0"}))}}async function submitAddressForm(forms){const data=new FormData(forms);let indicator=forms.querySelector(".spinner-border");if(indicator){btn=indicator.closest("button");indicator.classList.remove("d-none");btn.disabled=true;btn.type="button"}await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{closeProgress();btn.type="submit";const contentType=response.headers.get("content-type");if(!contentType||!contentType.includes("application/json")){$errorFormHandler='{ "type":"danger" , '+'"header":"Ошибка"  , '+'"message" : "Возникла ошибка при заполнении" }';createToast(JSON.parse($errorFormHandler));throw new TypeError("Oops, we haven't got JSON!")}geoModal.hide();if(response.status===302){window.location.href="/refresh";return}return response.json()}).then(data=>{if(data===undefined){return false}if(data.status===200&&data.redirect!==undefined){window.location.href=data.redirect;return false}createToast(data);if(data.status!==200){return}changeAddress(forms)});return false}function changeAddress(forms){if(forms!==false&&forms.name==="user_address_form"){let btn=forms.querySelector('button[type="submit"]');var inputs=forms.elements;for(i=0;i<inputs.length;i++){if(inputs[i].id==="user_address_form_desc"){document.querySelectorAll("[data-address]").forEach(function(area){area.value=inputs[i].value})}if(inputs[i].id==="user_address_form_address"){let dataGeocode=document.querySelector("[data-geocode]");if(dataGeocode){dataGeocode.value=inputs[i].value}}if(inputs[i].id==="user_address_form_latitude"){let dataLatitude=document.querySelector("[data-latitude]");if(dataLatitude){dataLatitude.value=inputs[i].value}}if(inputs[i].id==="user_address_form_longitude"){let dataLongitude=document.querySelector("[data-longitude]");if(dataLongitude){dataLongitude.value=inputs[i].value}}}delete forms}}