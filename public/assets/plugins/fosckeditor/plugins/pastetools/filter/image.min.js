(function(){function d(j,o,h){o=b(o);var m,n;if(0===o.length){return j}m=CKEDITOR.tools.array.map(o,function(k){return f(k)},this);if(h.length!==m.length){return CKEDITOR.error("pastetools-failed-image-extraction",{rtf:o.length,html:h.length}),j}for(n=0;n<h.length;n++){if(0===h[n].indexOf("file://")){if(m[n]){var l=h[n].replace(/\\/g,"\\\\");j=j.replace(new RegExp("(\x3cimg [^\x3e]*src\x3d[\"']?)"+l),"$1"+m[n])}else{CKEDITOR.error("pastetools-unsupported-image",{type:o[n].type,index:n})}}}return j}function c(j,l,h){var k=CKEDITOR.tools.array.unique(CKEDITOR.tools.array.filter(h,function(m){return m.match(/^blob:/i)}));h=CKEDITOR.tools.array.map(k,a);CKEDITOR.tools.promise.all(h).then(function(m){CKEDITOR.tools.array.forEach(m,function(n,p){if(n){var o=k[p],o=j.editable().find('img[src\x3d"'+o+'"]').toArray();CKEDITOR.tools.array.forEach(o,function(q){q.setAttribute("src",n);q.setAttribute("data-cke-saved-src",n)},this)}else{CKEDITOR.error("pastetools-unsupported-image",{type:"blob",index:p})}})});return l}function b(C){function A(h){return"string"!==typeof h?-1:CKEDITOR.tools.array.indexOf(z,function(k){return k.id===h})}function B(k){var h=k.match(/\\blipuid (\w+)\}/);k=k.match(/\\bliptag(-?\d+)/);return h?h[1]:k?k[1]:null}var y=CKEDITOR.plugins.pastetools.filters.common.rtf,z=[];C=y.removeGroups(C,"(?:(?:header|footer)[lrf]?|nonshppict|shprslt)");C=y.getGroups(C,"pict");if(!C){return z}for(var u=0;u<C.length;u++){var w=C[u].content,v=B(w),r=g(w),x=A(v),o=-1!==x&&z[x].hex,t=o&&z[x].type===r,o=o&&z[x].type!==r&&x===z.length-1,s=-1!==w.indexOf("\\defshp"),j=-1!==CKEDITOR.tools.array.indexOf(CKEDITOR.pasteFilters.image.supportedImageTypes,r);t?z.push(z[x]):o||s||(w={id:v,hex:j?y.extractGroupContent(w).replace(/\s/g,""):null,type:r},-1!==x?z.splice(x,1,w):z.push(w))}return z}function i(j){for(var l=/<img[^>]+src="([^"]+)[^>]+/g,h=[],k;k=l.exec(j);){h.push(k[1])}return h}function g(h){var j=CKEDITOR.tools.array.find(CKEDITOR.pasteFilters.image.recognizableImageTypes,function(k){return k.marker.test(h)});return j?j.type:"unknown"}function f(j){var k=-1!==CKEDITOR.tools.array.indexOf(CKEDITOR.pasteFilters.image.supportedImageTypes,j.type),h=j.hex;if(!k){return null}"string"===typeof h&&(h=CKEDITOR.tools.convertHexStringToBytes(j.hex));return j.type?"data:"+j.type+";base64,"+CKEDITOR.tools.convertBytesToBase64(h):null}function a(h){return new CKEDITOR.tools.promise(function(j){CKEDITOR.ajax.load(h,function(k){k=new Uint8Array(k);var l=e(k);k=f({type:l,hex:k});j(k)},"arraybuffer")})}function e(h){h=h.subarray(0,4);var j=CKEDITOR.tools.array.map(h,function(k){return k.toString(16)}).join("");return(h=CKEDITOR.tools.array.find(CKEDITOR.pasteFilters.image.recognizableImageSignatures,function(k){return 0===j.indexOf(k.signature)}))?h.type:null}CKEDITOR.pasteFilters.image=function(j,l,h){var k;if(l.activeFilter&&!l.activeFilter.check("img[src]")){return j}k=i(j);return 0===k.length?j:h?d(j,h,k):c(l,j,k)};CKEDITOR.pasteFilters.image.extractFromRtf=b;CKEDITOR.pasteFilters.image.extractTagsFromHtml=i;CKEDITOR.pasteFilters.image.getImageType=g;CKEDITOR.pasteFilters.image.createSrcWithBase64=f;CKEDITOR.pasteFilters.image.convertBlobUrlToBase64=a;CKEDITOR.pasteFilters.image.getImageTypeFromSignature=e;CKEDITOR.pasteFilters.image.supportedImageTypes=["image/png","image/jpeg","image/gif"];CKEDITOR.pasteFilters.image.recognizableImageTypes=[{marker:/\\pngblip/,type:"image/png"},{marker:/\\jpegblip/,type:"image/jpeg"},{marker:/\\emfblip/,type:"image/emf"},{marker:/\\wmetafile\d/,type:"image/wmf"}];CKEDITOR.pasteFilters.image.recognizableImageSignatures=[{signature:"ffd8ff",type:"image/jpeg"},{signature:"47494638",type:"image/gif"},{signature:"89504e47",type:"image/png"}]})();