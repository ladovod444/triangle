"use strict";(function(){CKEDITOR.plugins.add("autocomplete",{requires:"textwatcher",onLoad:function(){CKEDITOR.document.appendStyleSheet(this.path+"skins/default.css")},isSupportedEnvironment:function(){return !CKEDITOR.env.ie||CKEDITOR.env.version>8}});function c(g,f){var h=g.config.autocomplete_commitKeystrokes||CKEDITOR.config.autocomplete_commitKeystrokes;this.editor=g;this.throttle=f.throttle!==undefined?f.throttle:20;this.view=this.getView();this.model=this.getModel(f.dataCallback);this.model.itemsLimit=f.itemsLimit;this.textWatcher=this.getTextWatcher(f.textTestCallback);this.commitKeystrokes=CKEDITOR.tools.array.isArray(h)?h.slice():[h];this._listeners=[];this.outputTemplate=f.outputTemplate!==undefined?new CKEDITOR.template(f.outputTemplate):null;if(f.itemTemplate){this.view.itemTemplate=new CKEDITOR.template(f.itemTemplate)}if(this.editor.status==="ready"){this.attach()}else{this.editor.on("instanceReady",function(){this.attach()},this)}g.on("destroy",function(){this.destroy()},this)}c.prototype={attach:function(){var h=this.editor,i=CKEDITOR.document.getWindow(),f=h.editable(),g=f.isInline()?f:f.getDocument();if(CKEDITOR.env.iOS&&!f.isInline()){g=b(h)}this.view.append();this.view.attach();this.textWatcher.attach();this._listeners.push(this.textWatcher.on("matched",this.onTextMatched,this));this._listeners.push(this.textWatcher.on("unmatched",this.onTextUnmatched,this));this._listeners.push(this.model.on("change-data",this.modelChangeListener,this));this._listeners.push(this.model.on("change-selectedItemId",this.onSelectedItemId,this));this._listeners.push(this.view.on("change-selectedItemId",this.onSelectedItemId,this));this._listeners.push(this.view.on("click-item",this.onItemClick,this));this._listeners.push(i.on("scroll",function(){this.viewRepositionListener()},this));this._listeners.push(g.on("scroll",function(){this.viewRepositionListener()},this));this._listeners.push(this.view.element.on("mousedown",function(j){j.data.preventDefault()},null,null,9999));if(f){this.registerPanelNavigation()}h.on("contentDom",function(){this.registerPanelNavigation()},this)},registerPanelNavigation:function(){var f=this.editor.editable();this._listeners.push(f.attachListener(f,"keydown",function(g){this.onKeyDown(g)},this,null,5))},close:function(){this.model.setActive(false);this.view.close()},commit:function(h){if(!this.model.isActive){return}this.close();if(h==null){h=this.model.selectedItemId;if(h==null){return}}var g=this.model.getItemById(h),f=this.editor;f.fire("saveSnapshot");f.getSelection().selectRanges([this.model.range]);f.insertHtml(this.getHtmlToInsert(g),"text");f.fire("saveSnapshot")},destroy:function(){CKEDITOR.tools.array.forEach(this._listeners,function(f){f.removeListener()});this._listeners=[];this.view.element&&this.view.element.remove()},getHtmlToInsert:function(g){var f=a(g);return this.outputTemplate?this.outputTemplate.output(f):f.name},getModel:function(f){var g=this;return new d(function(h,i){return f.call(this,CKEDITOR.tools.extend({autocomplete:g},h),i)})},getTextWatcher:function(f){return new CKEDITOR.plugins.textWatcher(this.editor,f,this.throttle)},getView:function(){return new e(this.editor)},open:function(){if(this.model.hasData()){this.model.setActive(true);this.view.open();this.model.selectFirst();this.view.updatePosition(this.model.range)}},viewRepositionListener:function(){if(this.model.isActive){this.view.updatePosition(this.model.range)}},modelChangeListener:function(f){if(this.model.hasData()){this.view.updateItems(f.data);this.open()}else{this.close()}},onItemClick:function(f){this.commit(f.data)},onKeyDown:function(f){if(!this.model.isActive){return}var h=f.data.getKey(),g=false;if(h==27){this.close();this.textWatcher.unmatch();g=true}else{if(h==40){this.model.selectNext();g=true}else{if(h==38){this.model.selectPrevious();g=true}else{if(CKEDITOR.tools.indexOf(this.commitKeystrokes,h)!=-1){this.commit();this.textWatcher.unmatch();g=true}}}}if(g){f.cancel();f.data.preventDefault();this.textWatcher.consumeNext()}},onSelectedItemId:function(f){this.model.setItem(f.data);this.view.selectItem(f.data)},onTextMatched:function(f){this.model.setActive(false);this.model.setQuery(f.data.text,f.data.range)},onTextUnmatched:function(){this.model.query=null;this.model.lastRequestId=null;this.close()}};function e(f){this.itemTemplate=new CKEDITOR.template('<li data-id="{id}">{name}</li>');this.editor=f}e.prototype={append:function(){this.document=CKEDITOR.document;this.element=this.createElement();this.document.getBody().append(this.element)},appendItems:function(f){this.element.setHtml("");this.element.append(f)},attach:function(){this.element.on("click",function(f){var h=f.data.getTarget(),g=h.getAscendant(this.isItemElement,true);if(g){this.fire("click-item",g.data("id"))}},this);this.element.on("mouseover",function(f){var g=f.data.getTarget();if(this.element.contains(g)){g=g.getAscendant(function(i){return i.hasAttribute("data-id")},true);if(!g){return}var h=g.data("id");this.fire("change-selectedItemId",h)}},this)},close:function(){this.element.removeClass("cke_autocomplete_opened")},createElement:function(){var f=new CKEDITOR.dom.element("ul",this.document);f.addClass("cke_autocomplete_panel");f.setStyle("z-index",this.editor.config.baseFloatZIndex-3);return f},createItem:function(g){var f=a(g);return CKEDITOR.dom.element.createFromHtml(this.itemTemplate.output(f),this.document)},getViewPosition:function(h){var g=h.getClientRects(),f=g[g.length-1],l,j=this.editor.editable();if(j.isInline()){l=CKEDITOR.document.getWindow().getScrollPosition()}else{l=j.getParent().getDocumentPosition(CKEDITOR.document)}var k=CKEDITOR.document.getBody();if(k.getComputedStyle("position")==="static"){k=k.getParent()}var i=k.getDocumentPosition();l.x-=i.x;l.y-=i.y;return{top:(f.top+l.y),bottom:(f.top+f.height+l.y),left:(f.left+l.x)}},getItemById:function(f){return this.element.findOne('li[data-id="'+f+'"]')},isItemElement:function(f){return f.type==CKEDITOR.NODE_ELEMENT&&Boolean(f.data("id"))},open:function(){this.element.addClass("cke_autocomplete_opened")},selectItem:function(g){if(this.selectedItemId!=null){this.getItemById(this.selectedItemId).removeClass("cke_autocomplete_selected")}var f=this.getItemById(g);f.addClass("cke_autocomplete_selected");this.selectedItemId=g;this.scrollElementTo(f)},setPosition:function(i){var f=this.element.getWindow(),h=f.getViewPaneSize(),l=m({editorViewportRect:g(this.editor),caretRect:i,viewHeight:this.element.getSize("height"),scrollPositionY:f.getScrollPosition().y,windowHeight:h.height}),k=j({leftPosition:i.left,viewWidth:this.element.getSize("width"),windowWidth:h.width});this.element.setStyles({left:k+"px",top:l+"px"});function m(w){var s=w.editorViewportRect,p=w.caretRect,q=w.viewHeight,v=w.scrollPositionY,n=w.windowHeight;if(s.bottom<p.bottom){return Math.min(p.top,s.bottom)-q}var r=p.top-s.top,t=s.bottom-p.bottom,u=(p.top-q)<v;if(q>t&&q<r&&!u){return p.top-q}if(s.top>p.top){return Math.max(p.bottom,s.top)}var o=(p.bottom+q)>(n+v);if(!(q>t&&q<r)&&o){return p.top-q}return Math.min(s.bottom,p.bottom)}function j(o){var n=o.leftPosition,q=o.viewWidth,p=o.windowWidth;if(n+q>p){return p-q}return n}function g(o){var n=o.editable();if(CKEDITOR.env.iOS&&!n.isInline()){return b(o).getClientRect(true)}else{return n.isInline()?n.getClientRect(true):o.window.getFrame().getClientRect(true)}}},scrollElementTo:function(f){f.scrollIntoParent(this.element)},updateItems:function(f){var g,h=new CKEDITOR.dom.documentFragment(this.document);for(g=0;g<f.length;++g){h.append(this.createItem(f[g]))}this.appendItems(h);this.selectedItemId=null},updatePosition:function(f){this.setPosition(this.getViewPosition(f))}};CKEDITOR.event.implementOn(e.prototype);function d(f){this.dataCallback=f;this.isActive=false;this.itemsLimit=0}d.prototype={getIndexById:function(j){if(!this.hasData()){return -1}for(var h=this.data,g=0,f=h.length;g<f;g++){if(h[g].id==j){return g}}return -1},getItemById:function(g){var f=this.getIndexById(g);return ~f&&this.data[f]||null},hasData:function(){return Boolean(this.data&&this.data.length)},setItem:function(f){if(this.getIndexById(f)<0){throw new Error("Item with given id does not exist")}this.selectedItemId=f},select:function(f){this.fire("change-selectedItemId",f)},selectFirst:function(){if(this.hasData()){this.select(this.data[0].id)}},selectLast:function(){if(this.hasData()){this.select(this.data[this.data.length-1].id)}},selectNext:function(){if(this.selectedItemId==null){this.selectFirst();return}var f=this.getIndexById(this.selectedItemId);if(f<0||f+1==this.data.length){this.selectFirst()}else{this.select(this.data[f+1].id)}},selectPrevious:function(){if(this.selectedItemId==null){this.selectLast();return}var f=this.getIndexById(this.selectedItemId);if(f<=0){this.selectLast()}else{this.select(this.data[f-1].id)}},setActive:function(f){this.isActive=f;this.fire("change-isActive",f)},setQuery:function(i,f){var h=this,j=CKEDITOR.tools.getNextId();this.lastRequestId=j;this.query=i;this.range=f;this.data=null;this.selectedItemId=null;this.dataCallback({query:i,range:f},g);function g(k){if(j==h.lastRequestId){if(h.itemsLimit){h.data=k.slice(0,h.itemsLimit)}else{h.data=k}h.fire("change-data",h.data)}}}};CKEDITOR.event.implementOn(d.prototype);CKEDITOR.plugins.autocomplete=c;c.view=e;c.model=d;CKEDITOR.config.autocomplete_commitKeystrokes=[9,13];function b(f){return f.window.getFrame().getParent()}function a(f){return CKEDITOR.tools.array.reduce(CKEDITOR.tools.object.keys(f),function(h,g){h[g]=CKEDITOR.tools.htmlEncode(f[g]);return h},{})}})();