var limit_nWgkuzbCRs=1e3;setTimeout(function init_YFwgubGn(){var object_product=document.getElementById("moving_product_stock_form_preProduct");if(object_product){let focus=document.getElementById("moving_product_stock_form_preProduct_select2");focus?focus.click():null;object_product.addEventListener("change",function(event){let forms=this.closest("form");changeObjectProduct(forms);return false});let $addButtonStock=document.getElementById("moving_product_stock_form_addMoving");if($addButtonStock){$addButtonStock.addEventListener("click",addProductMoving,false)}return}if(limit_nWgkuzbCRs>1e3){return}limit_nWgkuzbCRs=limit_nWgkuzbCRs*2;setTimeout(init_YFwgubGn,limit_nWgkuzbCRs)},100);async function changeObjectProduct(forms){const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preOffer=result.getElementById("preOffer");preOffer?document.getElementById("preOffer").replaceWith(preOffer):preOffer.innerHTML="";if(preOffer){let replaceOfferId="moving_product_stock_form_preOffer";let replacer=document.getElementById(replaceOfferId);if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true})}let focus=document.getElementById("moving_product_stock_form_preOffer_select2");focus?focus.click():null}else{let targetWarehouse=result.getElementById("targetWarehouse");if(targetWarehouse){document.getElementById("targetWarehouse").replaceWith(targetWarehouse);let replacerWarehouse=document.getElementById("moving_product_stock_form_targetWarehouse");replacer.addEventListener("change",changeObjectWarehause,false);if(replacerWarehouse&&replacerWarehouse.tagName==="SELECT"){new NiceSelect(replacerWarehouse,{searchable:true})}}}let preVariation=document.getElementById("preVariation");preVariation?preVariation.innerHTML="":null;let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null;let offerChange=document.getElementById("moving_product_stock_form_preOffer");if(offerChange){offerChange.addEventListener("change",function(event){changeObjectOffer(forms);return false})}}})}function _changeObjectProduct(){let replaceId="moving_product_stock_form_preOffer";const requestModalName=new XMLHttpRequest;requestModalName.responseType="document";let MovingForm=document.forms.moving_product_stock_form;let formData=new FormData;formData.append(this.getAttribute("name"),this.value);requestModalName.open(MovingForm.getAttribute("method"),MovingForm.getAttribute("action"),true);requestModalName.setRequestHeader("X-Requested-With","XMLHttpRequest");requestModalName.addEventListener("readystatechange",function(){if(requestModalName.readyState===4&&requestModalName.status===200){let result=requestModalName.response.getElementById("preOffer");document.getElementById("preOffer").replaceWith(result);let replacer=document.getElementById(replaceId);if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true,id:"select2-"+replaceId});let offerChange=document.getElementById("moving_product_stock_form_preOffer");if(offerChange){offerChange.addEventListener("change",changeObjectOffer,false)}}let warehouse=requestModalName.response.getElementById("targetWarehouse");document.getElementById("targetWarehouse").replaceWith(warehouse);document.getElementById("moving_product_stock_form_targetWarehouse").addEventListener("change",changeObjectWarehause,false);new NiceSelect(document.getElementById("moving_product_stock_form_targetWarehouse"),{searchable:true,id:"select2-"+replaceId})}return false});requestModalName.send(formData)}async function changeObjectOffer(forms){const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preVariation=result.getElementById("preVariation");if(preVariation){document.getElementById("preVariation").replaceWith(preVariation);let replacer=document.getElementById("moving_product_stock_form_preVariation");if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true})}replacer.addEventListener("change",function(event){changeObjectVariation(forms);return false});let focus=document.getElementById("moving_product_stock_form_preVariation_select2");focus?focus.click():null}}else{let targetWarehouse=result.getElementById("targetWarehouse");if(targetWarehouse){document.getElementById("targetWarehouse").replaceWith(targetWarehouse);let replacerWarehouse=document.getElementById("moving_product_stock_form_targetWarehouse");replacer.addEventListener("change",changeObjectWarehause,false);if(replacerWarehouse&&replacerWarehouse.tagName==="SELECT"){new NiceSelect(replacerWarehouse,{searchable:true})}}}let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null}})}function _changeObjectOffer(){let replaceId="moving_product_stock_form_preVariation";const requestModalName=new XMLHttpRequest;requestModalName.responseType="document";let MovingForm=document.forms.moving_product_stock_form;let formData=new FormData;formData.append(this.getAttribute("name"),this.value);const product=document.getElementById("moving_product_stock_form_preProduct");formData.append(product.getAttribute("name"),product.value);requestModalName.open(MovingForm.getAttribute("method"),MovingForm.getAttribute("action"),true);requestModalName.setRequestHeader("X-Requested-With","XMLHttpRequest");requestModalName.addEventListener("readystatechange",function(){if(requestModalName.readyState===4&&requestModalName.status===200){let result=requestModalName.response.getElementById("preVariation");document.getElementById("preVariation").replaceWith(result);let replacer=document.getElementById(replaceId);if(replacer.tagName==="SELECT"){new NiceSelect(document.getElementById(replaceId),{searchable:true,id:"select2-"+replaceId});let offerVariation=document.getElementById("moving_product_stock_form_preVariation");if(offerVariation){offerVariation.addEventListener("change",changeObjectVariation,false)}}let warehouse=requestModalName.response.getElementById("targetWarehouse");document.getElementById("targetWarehouse").replaceWith(warehouse);document.getElementById("moving_product_stock_form_targetWarehouse").addEventListener("change",changeObjectWarehause,false);new NiceSelect(document.getElementById("moving_product_stock_form_targetWarehouse"),{searchable:true,id:"select2-"+replaceId})}return false});requestModalName.send(formData)}async function changeObjectVariation(forms){const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preModification=result.getElementById("preModification");if(preModification){document.getElementById("preModification").replaceWith(preModification);let replacer=document.getElementById("moving_product_stock_form_preModification");if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true})}replacer.addEventListener("change",function(event){changeObjectModification(forms);return false});let focus=document.getElementById("moving_product_stock_form_preModification_select2");focus?focus.click():null}}else{let targetWarehouse=result.getElementById("targetWarehouse");if(targetWarehouse){document.getElementById("targetWarehouse").replaceWith(targetWarehouse);let replacerWarehouse=document.getElementById("moving_product_stock_form_targetWarehouse");replacer.addEventListener("change",changeObjectWarehause,false);if(replacerWarehouse&&replacerWarehouse.tagName==="SELECT"){new NiceSelect(replacerWarehouse,{searchable:true})}}}}})}function _changeObjectVariation(){let replaceId="moving_product_stock_form_preModification";const requestModalName=new XMLHttpRequest;requestModalName.responseType="document";let MovingForm=document.forms.moving_product_stock_form;let formData=new FormData;formData.append(this.getAttribute("name"),this.value);const product=document.getElementById("moving_product_stock_form_preProduct");formData.append(product.getAttribute("name"),product.value);const offer=document.getElementById("moving_product_stock_form_preOffer");formData.append(offer.getAttribute("name"),offer.value);requestModalName.open(MovingForm.getAttribute("method"),MovingForm.getAttribute("action"),true);requestModalName.setRequestHeader("X-Requested-With","XMLHttpRequest");requestModalName.addEventListener("readystatechange",function(){if(requestModalName.readyState===4&&requestModalName.status===200){let result=requestModalName.response.getElementById("preModification");document.getElementById("preModification").replaceWith(result);let replacer=document.getElementById(replaceId);if(replacer.tagName==="SELECT"){new NiceSelect(document.getElementById(replaceId),{searchable:true,id:"select2-"+replaceId});let offerModification=document.getElementById("moving_product_stock_form_preModification");if(offerModification){offerModification.addEventListener("change",changeObjectModification,false)}}let warehouse=requestModalName.response.getElementById("targetWarehouse");document.getElementById("targetWarehouse").replaceWith(warehouse);document.getElementById("moving_product_stock_form_targetWarehouse").addEventListener("change",changeObjectWarehause,false);new NiceSelect(document.getElementById("moving_product_stock_form_targetWarehouse"),{searchable:true,id:"select2-"+replaceId})}return false});requestModalName.send(formData)}async function changeObjectModification(forms){const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let targetWarehouse=result.getElementById("targetWarehouse");targetWarehouse.querySelector("#moving_product_stock_form_targetWarehouse").classList.remove("is-invalid");targetWarehouse.querySelector(".invalid-feedback")?.remove();if(targetWarehouse){document.getElementById("targetWarehouse").replaceWith(targetWarehouse);let replacer=document.getElementById("moving_product_stock_form_targetWarehouse");replacer.addEventListener("change",changeObjectWarehause,false);if(replacer&&replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true})}let focus=document.getElementById("moving_product_stock_form_targetWarehouse_select2");focus?focus.click():null}}})}function _changeObjectModification(){let replaceId="moving_product_stock_form_targetWarehouse";const requestModalName=new XMLHttpRequest;requestModalName.responseType="document";let MovingForm=document.forms.moving_product_stock_form;let formData=new FormData;formData.append(this.getAttribute("name"),this.value);const product=document.getElementById("moving_product_stock_form_preProduct");formData.append(product.getAttribute("name"),product.value);const offer=document.getElementById("moving_product_stock_form_preOffer");formData.append(offer.getAttribute("name"),offer.value);const variation=document.getElementById("moving_product_stock_form_preVariation");formData.append(variation.getAttribute("name"),variation.value);requestModalName.open(MovingForm.getAttribute("method"),MovingForm.getAttribute("action"),true);requestModalName.setRequestHeader("X-Requested-With","XMLHttpRequest");requestModalName.addEventListener("readystatechange",function(){if(requestModalName.readyState===4&&requestModalName.status===200){let result=requestModalName.response.getElementById("targetWarehouse");document.getElementById("targetWarehouse").replaceWith(result);let replacer=document.getElementById(replaceId);document.getElementById("moving_product_stock_form_targetWarehouse").addEventListener("change",changeObjectWarehause,false);if(replacer.tagName==="SELECT"){new NiceSelect(document.getElementById(replaceId),{searchable:true,id:"select2-"+replaceId})}}return false});requestModalName.send(formData)}function changeObjectWarehause(){let index=this.selectedIndex;document.getElementById("moving_product_stock_form_preTotal").setAttribute("max",this.options[index].dataset.max);document.getElementById("moving_product_stock_form_destinationWarehouse").addEventListener("change",()=>{setTimeout(function(){let focusTotal=document.getElementById("moving_product_stock_form_preTotal");focusTotal?focusTotal.focus():null},100)},false);setTimeout(function(){let focusDestination=document.getElementById("moving_product_stock_form_destinationWarehouse_select2");focusDestination?focusDestination.click():null},100)}var collectionStock=new Map;function addProductMoving(){let $blockCollectionStock=document.getElementById("collectionStock");let $errorFormHandler=null;let header="Добавить лист перемещения продукции";let $preTotal=document.getElementById("moving_product_stock_form_preTotal");let $TOTAL=$preTotal.value*1;let $totalMax=$preTotal.getAttribute("max");if($TOTAL===undefined||$TOTAL<1||$TOTAL>$totalMax){if($TOTAL===undefined){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Ошибка при заполнение количество" }'}if($TOTAL>$totalMax){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Недостаточное количество на складе" }'}if($TOTAL<1){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Не указано количество для перемещения" }'}}let $targetWarehouse=document.getElementById("moving_product_stock_form_targetWarehouse");if($targetWarehouse.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"Добавить лист закупки продукции"  , '+'"message" : "'+$targetWarehouse.options[0].textContent+'" }'}let $destinationWarehouse=document.getElementById("moving_product_stock_form_destinationWarehouse");if($destinationWarehouse.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"Добавить лист закупки продукции"  , '+'"message" : "'+$destinationWarehouse.options[0].textContent+'" }'}let $preProduct=document.getElementById("moving_product_stock_form_preProduct");if($preProduct.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preProduct.options[0].textContent+'" }'}let $preOffer=document.getElementById("moving_product_stock_form_preOffer");if($preOffer){if($preOffer.tagName==="SELECT"&&$preOffer.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preOffer.options[0].textContent+'" }'}}let $preVariation=document.getElementById("moving_product_stock_form_preVariation");if($preVariation){if($preVariation.tagName==="SELECT"&&$preVariation.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preVariation.options[0].textContent+'" }'}}let $preModification=document.getElementById("moving_product_stock_form_preModification");if($preModification){if($preModification.tagName==="SELECT"&&$preModification.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preModification.options[0].textContent+'" }'}}if($targetWarehouse.value===$destinationWarehouse.value){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Внутренее перемещение! Выберите другой склад назначения либо отгрузки" }'}if(collectionStock.has($targetWarehouse.value+$destinationWarehouse.value+$preProduct.value+$preOffer.value+$preVariation.value+$preModification.value)){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Продукция уже добавлена в список" }'}if(collectionStock.size>=5){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Количество в заявке временно ограничено до 5 позиций! Сохраните активную и добавьте новую." }'}if($errorFormHandler){createToast(JSON.parse($errorFormHandler));return false}let $addButtonStock=this;let newForm=$addButtonStock.dataset.prototype;let index=$addButtonStock.dataset.index*1;newForm=newForm.replace(/__product__/g,index);let stockDiv=document.createElement("div");stockDiv.classList.add("item-collection-product");stockDiv.classList.add("w-100");stockDiv.innerHTML=newForm;$blockCollectionStock.append(stockDiv);let productIndex=$preProduct.selectedIndex;let $productName=$preProduct.options[productIndex].dataset.name;let targetWarehouseIndex=$targetWarehouse.selectedIndex;let $targetWarehouseName=$targetWarehouse.options[targetWarehouseIndex].dataset.name;let destinationWarehouseIndex=$destinationWarehouse.selectedIndex;let $destinationWarehouseName=$destinationWarehouse.options[destinationWarehouseIndex].textContent;let variationIndex=$preVariation.selectedIndex;let $variationName=$preVariation.tagName==="SELECT"?document.querySelector('label[for="'+$preVariation.id+'"]').textContent+" "+$preVariation.options[variationIndex].dataset.name:"";let modificationIndex=$preModification.selectedIndex;let $modificationName=$preModification.tagName==="SELECT"?document.querySelector('label[for="'+$preModification.id+'"]').textContent+" "+$preModification.options[modificationIndex].dataset.name:"";let offerIndex=$preOffer.selectedIndex;let $offerName=$preOffer.tagName==="SELECT"?document.querySelector('label[for="'+$preOffer.id+'"]').textContent+" "+$preOffer.options[offerIndex].dataset.name:"";let $productTextBlock=stockDiv.querySelector("#product-text-"+index);$productTextBlock.innerHTML=$targetWarehouseName+"&nbsp; => &nbsp;"+$destinationWarehouseName+" &nbsp; : &nbsp; "+$productName+" "+$offerName+" "+$variationName+" "+$modificationName+"&nbsp; : &nbsp;"+$TOTAL+" шт.";let $warehouse=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_move_warehouse");let $destination=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_move_destination");let $product=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_product_"+index+"_product");let $offer=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_product_"+index+"_offer");let $variation=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_product_"+index+"_variation");let $modification=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_product_"+index+"_modification");let $total=stockDiv.querySelector("#moving_product_stock_form_move_"+index+"_product_"+index+"_total");$warehouse.value=$targetWarehouse.value;$destination.value=$destinationWarehouse.value;$product.value=$preProduct.value;$offer.value=$preOffer.value;$variation.value=$preVariation.value;$modification.value=$preModification.value;$total.value=$preTotal.value;stockDiv.querySelector(".del-item-product").addEventListener("click",function(){this.closest(".item-collection-product").remove();index=$addButtonStock.dataset.index*1;$addButtonStock.dataset.index=(index-1).toString()});$addButtonStock.dataset.index=(index+1).toString();$preTotal.value=null;collectionStock.set($targetWarehouse.value+$destinationWarehouse.value+$preProduct.value+$preOffer.value+$preVariation.value+$preModification.value);document.getElementById("moving_product_stock_form_preOffer_select2").remove();document.getElementById("moving_product_stock_form_preVariation_select2").remove();document.getElementById("moving_product_stock_form_preModification_select2").remove();setTimeout(()=>{document.getElementById("moving_product_stock_form_preProduct_select2").click()},100)}