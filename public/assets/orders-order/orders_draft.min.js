/*
 *  Copyright 2025.  Baks.dev <admin@baks.dev>
 *  
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is furnished
 *  to do so, subject to the following conditions:
 *  
 *  The above copyright notice and this permission notice shall be included in all
 *  copies or substantial portions of the Software.
 *  
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NON INFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 */

async function changeObjectCategory(forms){disabledElementsForm(forms);document.getElementById("preProduct")?.classList.add("d-none");document.getElementById("preOffer")?.classList.add("d-none");document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preProduct=result.getElementById("preProduct");document.getElementById("preProduct").replaceWith(preProduct);preProduct?document?.getElementById("product")?.replaceWith(preProduct):preProduct.innerHTML="";let replacer=document.getElementById(forms.name+"_preProduct_preProduct");replacer&&replacer.type!=="hidden"?preProduct.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preProduct_preProduct_select2");focus?focus.click():null}}let preOffer=document.getElementById("preOffer");preOffer?preOffer.innerHTML="":null;let preVariation=document.getElementById("preVariation");preVariation?preVariation.innerHTML="":null;let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null;if(replacer){replacer.addEventListener("change",function(event){changeObjectProduct(forms);return false})}}enableElementsForm(forms)})}async function changeObjectProduct(forms){disabledElementsForm(forms);document.getElementById("preOffer")?.classList.add("d-none");document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preOffer=result.getElementById("preOffer");preOffer?document.getElementById("preOffer").replaceWith(preOffer):preOffer.innerHTML="";if(preOffer){let replaceOfferId=forms.name+"_preProduct_preOffer";let replacer=document.getElementById(replaceOfferId);replacer&&replacer.type!=="hidden"?preOffer.classList.remove("d-none"):null;if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preProduct_preOffer_select2");focus?focus.click():null}else{selectTotal(document.getElementById(forms.name+"_preProduct_preProduct"))}}let preVariation=document.getElementById("preVariation");preVariation?preVariation.innerHTML="":null;let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null;let offerChange=document.getElementById(forms.name+"_preProduct_preOffer");if(offerChange){offerChange.addEventListener("change",function(event){changeObjectOffer(forms);return false})}}enableElementsForm(forms)})}async function changeObjectOffer(forms){disabledElementsForm(forms);document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preVariation=result.getElementById("preVariation");if(preVariation){document.getElementById("preVariation").replaceWith(preVariation);let replacer=document.getElementById(forms.name+"_preProduct_preVariation");replacer&&replacer.type!=="hidden"?preVariation.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preProduct_preVariation_select2");focus?focus.click():null;replacer.addEventListener("change",function(event){changeObjectVariation(forms);return false})}else{selectTotal(document.getElementById(forms.name+"_preProduct_preOffer"))}}}else{let targetWarehouse=result.getElementById("targetWarehouse");if(targetWarehouse){document.getElementById("targetWarehouse").replaceWith(targetWarehouse);let replacerWarehouse=document.getElementById(forms.name+"_preProduct_targetWarehouse");replacer.addEventListener("change",changeObjectWarehause,false);if(replacerWarehouse&&replacerWarehouse.tagName==="SELECT"){new NiceSelect(replacerWarehouse,{searchable:true})}}}let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null}enableElementsForm(forms)})}async function changeObjectVariation(forms){disabledElementsForm(forms);document.getElementById("preModification")?.classList.add("d-none");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preModification=result.getElementById("preModification");if(preModification){document.getElementById("preModification").replaceWith(preModification);let replacer=document.getElementById(forms.name+"_preProduct_preModification");replacer&&replacer.type!=="hidden"?preModification.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preProduct_preModification_select2");focus?focus.click():null;replacer.addEventListener("change",function(event){selectTotal(this);return false})}else{selectTotal(document.getElementById(forms.name+"_preProduct_preVariation"))}}}}enableElementsForm(forms)})}function selectTotal(element){let index=element.selectedIndex;let preProduct_preTotal=document.getElementById("new_order_form_preProduct_preTotal");preProduct_preTotal.setAttribute("max",element.options[index].dataset.max);setTimeout(function(){let focusTotal=document.getElementById("new_order_form_preProduct_preTotal");focusTotal.value="";focusTotal?focusTotal.focus():null},0)}var collectionProductOrder=new Map;function addProductOrder(){document.getElementById("preOffer")?.classList.add("d-none");document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");let $blockCollectionProducts=document.getElementById("collectionProductOrder");let $errorFormHandler=null;let header="Добавить продукцию в заказ";let $preTotal=document.getElementById("new_order_form_preProduct_preTotal");let $TOTAL=$preTotal.value*1;let $totalMax=$preTotal.getAttribute("max");if($TOTAL===undefined||$TOTAL<1||$TOTAL>$totalMax){if($TOTAL===undefined){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Ошибка при заполнение количество" }'}if($TOTAL>$totalMax){$warninfFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "На складе продукции отстутсвует необходимое количество" }';createToast(JSON.parse($warninfFormHandler))}if($TOTAL<1){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Не указано количество продукции" }'}}let $preProduct=document.getElementById("new_order_form_preProduct_preProduct");if($preProduct.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preProduct.options[0].textContent+'" }'}let $preOffer=document.getElementById("new_order_form_preProduct_preOffer");if($preOffer){if($preOffer.tagName==="SELECT"&&$preOffer.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preOffer.options[0].textContent+'" }'}}let $preVariation=document.getElementById("new_order_form_preProduct_preVariation");if($preVariation){if($preVariation.tagName==="SELECT"&&$preVariation.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preVariation.options[0].textContent+'" }'}}let $preModification=document.getElementById("new_order_form_preProduct_preModification");if($preModification){if($preModification.tagName==="SELECT"&&$preModification.value.length===0){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "'+$preModification.options[0].textContent+'" }'}}let mapKey=$preProduct?$preProduct.value:"";mapKey+=$preOffer?$preOffer.value:"";mapKey+=$preVariation?$preVariation.value:"";mapKey+=$preModification?$preModification.value:"";if(collectionProductOrder.has(mapKey)){$errorFormHandler='{ "type":"danger" , '+'"header":"'+header+'"  , '+'"message" : "Продукция уже добавлена в список" }'}if($errorFormHandler){createToast(JSON.parse($errorFormHandler));return false}let $addButtonStock=document.getElementById("new_order_form_addProduct");let newForm=$addButtonStock.dataset.prototype;let index=$addButtonStock.dataset.index*1;newForm=newForm.replace(/__product__/g,index);let stockDiv=document.createElement("div");stockDiv.classList.add("item-collection-product");stockDiv.classList.add("w-100");stockDiv.innerHTML=newForm;$blockCollectionProducts.append(stockDiv);let productIndex=$preProduct.selectedIndex;let $productName="<b>"+$preProduct.options[$preProduct.selectedIndex].dataset.name+"</b>";let $variationName=$preVariation?.tagName==="SELECT"?'<small class="text-muted">'+document.querySelector('label[for="'+$preVariation.id+'"]').textContent+"</small> <b>"+$preVariation.options[$preVariation.selectedIndex].dataset.name+"</b>":"";let $modificationName=$preModification?.tagName==="SELECT"?'<small class="text-muted">'+document.querySelector('label[for="'+$preModification.id+'"]').textContent+"</small> <b>"+$preModification.options[$preModification.selectedIndex].dataset.name+"</b>":"";let $offerName=$preOffer?.tagName==="SELECT"?'<small class="text-muted">'+document.querySelector('label[for="'+$preOffer.id+'"]').textContent+"</small> <b>"+$preOffer.options[$preOffer.selectedIndex].dataset.name+"</b>":"";let $productTextBlock=stockDiv.querySelector("#product-text-"+index);$productTextBlock.innerHTML=$productName+" "+$offerName+" "+$variationName+" "+$modificationName+"&nbsp; : &nbsp;<b>"+$TOTAL+" шт.</b>";let $product=stockDiv.querySelector("#new_order_form_product_"+index+"_product");let $offer=stockDiv.querySelector("#new_order_form_product_"+index+"_offer");let $variation=stockDiv.querySelector("#new_order_form_product_"+index+"_variation");let $modification=stockDiv.querySelector("#new_order_form_product_"+index+"_modification");let $total=stockDiv.querySelector("#new_order_form_product_"+index+"_price_total");$product.value=$preProduct?$preProduct.value:"";$offer.value=$preOffer?$preOffer.value:"";$variation.value=$preVariation?$preVariation.value:"";$modification.value=$preModification?$preModification.value:"";$total.value=$preTotal.value;stockDiv.querySelector(".del-item-product").addEventListener("click",function(){this.closest(".item-collection-product").remove();index=$addButtonStock.dataset.index*1;$addButtonStock.dataset.index=(index-1).toString();collectionProductOrder.delete(mapKey)});$addButtonStock.dataset.index=(index+1).toString();$preTotal.value=null;collectionProductOrder.set(mapKey,$total.value);document.getElementById("new_order_form_preProduct_preOffer_select2")?.remove();document.querySelector('label[for="new_order_form_preProduct_preOffer"]')?.remove();document.getElementById("new_order_form_preProduct_preVariation_select2")?.remove();document.querySelector('label[for="new_order_form_preProduct_preVariation"]')?.remove();document.getElementById("new_order_form_preProduct_preModification_select2")?.remove();document.querySelector('label[for="new_order_form_preProduct_preModification"]')?.remove();setTimeout(()=>{document.getElementById("new_order_form_preProduct_preProduct_select2").click()},100)}userProfileType=document.getElementById("new_order_form_usr_userProfile_type");if(userProfileType){userProfileType.addEventListener("change",function(event){let forms=this.closest("form");submitProfileForm(forms);return false})}document.querySelectorAll('input[name="new_order_form[usr][payment][payment]"]').forEach(function(userPayment){userPayment.addEventListener("change",function(event){let forms=this.closest("form");submitPaymentForm(forms);return false})});document.querySelectorAll('input[name="new_order_form[usr][delivery][delivery]"]').forEach(function(userPayment){userPayment.addEventListener("change",function(event){let forms=this.closest("form");submitDeliveryForm(forms);return false})});document.querySelectorAll("select.change_region_field").forEach(function(userRegion){userRegion.addEventListener("change",function(event){let forms=this.closest("form");submitRegionForm(forms,userRegion.id);return false});new NiceSelect(userRegion)});async function submitDeliveryForm(forms){disabledElementsForm(forms);const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var doc=parser.parseFromString(data,"text/html");let user_delivery=doc.getElementById("user_delivery");document.getElementById("user_delivery").replaceWith(user_delivery);document.querySelectorAll('input[name="new_order_form[usr][delivery][delivery]"]').forEach(function(user_delivery){user_delivery.addEventListener("change",function(event){let forms=this.closest("form");submitDeliveryForm(forms);return false})});document.querySelectorAll("select.change_region_field").forEach(function(userRegion){userRegion.addEventListener("change",function(event){let forms=this.closest("form");submitRegionForm(forms,userRegion.id);return false})});var tooltipTriggerList=[].slice.call(user_delivery.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl)});document.querySelectorAll(".js-datepicker").forEach(datepicker=>{let $elementDate=document.getElementById(datepicker.id).value;const[day,month,year]=$elementDate.split(".");$selectedDate=new Date(+year,month-1,+day);let nextDay=new Date;let currentDate=new Date;let limitDay=new Date(currentDate.setDate(currentDate.getDate()+7));MCDatepicker.create({el:"#"+datepicker.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths,selectedDate:$selectedDate==="Invalid Date"?new Date:$selectedDate,minDate:nextDay,maxDate:limitDay})});document.querySelector("[data-latitude]").value="";document.querySelector("[data-longitude]").value="";let dataUserAddress=document.querySelectorAll("[data-address]");if(dataUserAddress){dataUserAddress.forEach(function(area){area.value=""})}limitOxMvRIBczY=100;setTimeout(function OxMvRIBczY(){if(typeof initAdddress=="function"){initAdddress();return}if(limitOxMvRIBczY>1e3){return}limitOxMvRIBczY=limitOxMvRIBczY*2;setTimeout(OxMvRIBczY,limitOxMvRIBczY)},100)}enableElementsForm(forms)});return false}async function submitRegionForm(forms,id){disabledElementsForm(forms);const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var doc=parser.parseFromString(data,"text/html");let callId=id.replace(/_region/g,"_call");let call=doc.getElementById(callId);document.getElementById(callId).replaceWith(call);document.querySelector("[data-latitude]").value="";document.querySelector("[data-longitude]").value="";executeFunc(function ordersDraftAddres(){if(typeof initAdddress!=="function"){return false}initAdddress();return true})}enableElementsForm(forms)});return false}async function submitPaymentForm(forms){disabledElementsForm(forms);const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var doc=parser.parseFromString(data,"text/html");let user_payment=doc.getElementById("user_payment");document.getElementById("user_payment").replaceWith(user_payment);document.querySelectorAll('input[name="new_order_form[usr][payment][payment]"]').forEach(function(user_payment){user_payment.addEventListener("change",function(event){let forms=this.closest("form");submitPaymentForm(forms);return false})});var tooltipTriggerList=[].slice.call(user_payment.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl)})}enableElementsForm(forms)});return false}async function submitProfileForm(forms){disabledElementsForm(forms);const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var doc=parser.parseFromString(data,"text/html");let user_profile=doc.getElementById("user_profile");document.getElementById("user_profile").replaceWith(user_profile);userProfileType=document.getElementById("new_order_form_usr_userProfile_type");if(userProfileType.tagName==="SELECT"){new NiceSelect(userProfileType)}userProfileType.addEventListener("change",function(event){let forms=this.closest("form");submitProfileForm(forms);return false});let user_products=doc.getElementById("user_products");document.getElementById("user_products").replaceWith(user_products);var object_category=document.getElementById("new_order_form_preProduct_category");if(object_category){object_category.addEventListener("change",function(event){let forms=this.closest("form");changeObjectCategory(forms);return false});if(object_category.tagName==="SELECT"){new NiceSelect(object_category,{searchable:true})}}var object_product=document.getElementById("new_order_form_preProduct_preProduct");if(object_product){let focus=document.getElementById("new_order_form_preProduct_preProduct_select2");focus?focus.click():null;object_product.addEventListener("change",function(event){let forms=this.closest("form");changeObjectProduct(forms);return false});if(object_product.tagName==="SELECT"){new NiceSelect(object_product,{searchable:true})}let $addButtonStock=document.getElementById("new_order_form_addProduct");if($addButtonStock){$addButtonStock.addEventListener("click",addProductOrder,false)}}let user_payment=doc.getElementById("user_payment");document.getElementById("user_payment").replaceWith(user_payment);document.querySelectorAll('input[name="new_order_form[usr][payment][payment]"]').forEach(function(userPayment){userPayment.addEventListener("change",function(event){let replaceId="user_profile";let forms=this.closest("form");submitPaymentForm(forms);return false})});let user_delivery=doc.getElementById("user_delivery");document.getElementById("user_delivery").replaceWith(user_delivery);document.querySelectorAll('input[name="new_order_form[usr][delivery][delivery]"]').forEach(function(user_delivery){user_delivery.addEventListener("change",function(event){let forms=this.closest("form");submitDeliveryForm(forms);return false})});document.querySelectorAll("select.change_region_field").forEach(function(userRegion){userRegion.addEventListener("change",function(event){let forms=this.closest("form");submitRegionForm(forms,userRegion.id);return false})});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));tooltipTriggerList.map(function(tooltipTriggerEl){return new bootstrap.Tooltip(tooltipTriggerEl)});let lazy=document.createElement("script");lazy.src="/assets/js/lazyload.min.js";document.head.appendChild(lazy);document.querySelectorAll(".js-datepicker").forEach(datepicker=>{let $elementDate=document.getElementById(datepicker.id).value;const[day,month,year]=$elementDate.split(".");$selectedDate=new Date(+year,month-1,+day);let nextDay=new Date;let currentDate=new Date;let limitDay=new Date(currentDate.setDate(currentDate.getDate()+7));MCDatepicker.create({el:"#"+datepicker.id,bodyType:"modal",autoClose:false,closeOndblclick:true,closeOnBlur:false,customOkBTN:"OK",customClearBTN:datapickerLang[$locale].customClearBTN,customCancelBTN:datapickerLang[$locale].customCancelBTN,firstWeekday:datapickerLang[$locale].firstWeekday,dateFormat:"DD.MM.YYYY",customWeekDays:datapickerLang[$locale].customWeekDays,customMonths:datapickerLang[$locale].customMonths,selectedDate:$selectedDate==="Invalid Date"?nextDay:$selectedDate,minDate:nextDay,maxDate:limitDay})})}enableElementsForm(forms)});return false}